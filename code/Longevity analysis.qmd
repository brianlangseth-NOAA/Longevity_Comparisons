---
title: "Longevity analysis"
author: "Brian Langseth, Melissa Monk, Eric Ward"
format: pdf
editor: visual
editor_options: 
  chunk_output_type: console
---

## Exploration

```{r, include = FALSE}
#Load packages
library(here)
library(ggplot2)
library(dplyr)

##-------------------------------------------##
#Load data and process 
##-------------------------------------------##

data <- readRDS(here("data", "biol_data_ALL.rds"))

#Combine rougheye rockfish and rougheye/blackspotted rockfish complex
data[grepl("rougheye", data$common_name), "common_name"] <- "rougheye/blackspotted rockfish"

# #Summarize by name and survey, getting maxAge within each as well as count
# #Gives errors for combinations with no ages
# name_surv <- data %>%
#   dplyr::group_by(common_name, survey_id) %>%
#   dplyr::summarize(maxAge = max(age, na.rm = TRUE),
#             countAge = sum(!is.na(age)),
#             .groups = "keep")
#
# #Plotting all the surveys by species
# ggplot(name_surv, aes(x = common_name, y = maxAge, colour = survey_id)) +
#   geom_point()

#Remove records without ages (or with negative age). 
data_age <- data %>%
  dplyr::filter(age > 0)

#To compare within larger locales add area information
data_age <- data_age %>%
  mutate(area = case_when(
      grepl("AFSC", survey_id) ~ "AK",
      grepl("HBLL|SYN|Canada", survey_id) ~ "Canada",
      survey_id %in% c("NWFSC Combo", "NWFSC Slope", "Triennial") &
        lat > 46.26 ~ "WA",
      survey_id %in% c("NWFSC Combo", "NWFSC Slope", "Triennial") &
        lat > 42 ~ "OR",
      survey_id %in% c("NWFSC Combo", "NWFSC Slope", "Triennial") ~ "CA"
    ))

#Summarize by name and survey. Add numerical factor for names
name_surv <- data_age %>% 
  dplyr::group_by(common_name, survey_id) %>%
  dplyr::summarize(maxAge = max(age, na.rm = TRUE),
            countAge = sum(!is.na(age)),
            .groups = "keep")
name_surv$species_N <- as.numeric(as.factor(name_surv$common_name))

#Summarize by name and area (i.e. state). Add numerical factor for names
name_area <- data_age %>% 
  dplyr::group_by(common_name, area) %>%
  dplyr::summarize(maxAge = max(age, na.rm = TRUE),
            countAge = sum(!is.na(age)),
            .groups = "keep")
name_area$species_N <- as.numeric(as.factor(name_area$common_name))


#To better see ranges across surveys, group by species and provide max and min
name_surv_range <- name_surv %>%
  filter(is.finite(maxAge)) %>%
  group_by(common_name) %>%
  summarize(rangeMax = max(maxAge, na.rm = TRUE),
            rangeMin = min(maxAge, na.rm = TRUE))

name_area_range <- name_area %>%
  filter(is.finite(maxAge)) %>%
  group_by(common_name) %>%
  summarize(rangeMax = max(maxAge, na.rm = TRUE),
            rangeMin = min(maxAge, na.rm = TRUE))

name_area_range$diff = name_area_range$rangeMax - name_area_range$rangeMin

```

Age data were acquired from `r length(unique(data$survey_id)) - 1` fishery-independent surveys conducted along the U.S West Coast, Canada, and Alaska using code avaialble in the `surveyjoin-db` package. A total of `r nrow(data)` records across `r length(unique(data$common_name))` species were available, and of these, `r nrow(data_age)` samples across `r length(unique(data_age$common_name))` species included age information.

The surveys included among data available are:
1. Aleutian Islands Bottom Trawl Survey (AFSC AI)
2. Gulf of Alaska Bottom Trawl Survey (AFSC GOA)
3. Eastern & Northern Bering Sea Crab/Groundfish Bottom Trawl Surveys (AFSC EBS, AFSC NBS)
4. Eastern Bering Sea Slope Bottom Trawl Survey (AFSC BSS)
5. Fisheries and Oceans Canada Synoptic Bottom Trawl Surveys (with prefix SYN)
6. Fisheries and Oceans Canada Outside Hard Bottom Longline (HBLL OUT)
7. Fisheries and Oceans Canada Inside Hard Bottom Longline (HBLL INS)
8. West Coast Groundfish Bottomtrawl Shelf-Slope Survey (NWFSC Combo)
9. West Coast Groundfish Slope Survey (NWFSC Slope)
10. Triennial Shelf Trawl Survey (Triennial, Triennial Canada)

```{r, include = FALSE}

##-------------------------------------------##
#Map - Not shown
##-------------------------------------------##

library(maps)
library(mapdata)

mapData <- map('worldHires', regions=c("Canada","Mexico","US"),
               xlim=c(-200, -100), ylim=c(31, 75),
               col='grey', fill=TRUE, interior=TRUE, lwd=1, plot = FALSE)
# # map with US states
# map('state', regions=c("Wash","Oreg","Calif","Idaho","Alaska",
#                        "Montana","Nevada","Arizona","Utah"),
#     add=TRUE,
#     col='grey', fill=TRUE, interior=TRUE, lwd=1)
# axis(2, at=seq(32,50,2), lab=paste0(seq(32,50,2), "째N"), las=1)
# axis(1, at=seq(-130,-114,4), lab=paste0(abs(seq(-130,-114,4)), "째W"))

#Plot locations of non-unique locations
locs <- data %>% dplyr::select(survey_id, lat, lon) %>%
  dplyr::filter(!is.na(lon)) %>%
  unique()
# plot(locs$lat) #look good
# plot(locs$lon) #need to correct
locs[which(locs$lon > 0),"lon"] <- locs[which(locs$lon > 0), "lon"] * -1


ggplot() +
  geom_polygon(data = mapData, aes(x = long, y = lat, group = group), 
               fill = "black", color = "black") +
  coord_cartesian(xlim = c(-180, -110), ylim = c(30, 70)) +
  geom_point(data = locs, aes(x = lon, y = lat, color = survey_id), size = 1) +
  guides(color = guide_legend(ncol = 3)) + 
  theme_void() + 
  theme(legend.position = c(0.3,0.25))

```

```{r, echo = FALSE}

##-------------------------------------------##
#More advanced map - Shown
##-------------------------------------------##

#Another attempt with a better map
#Pulled parts from surveyjoin/data-raw/09-map-surveys.R

crs_out <- "EPSG:3338"
world_coordinates <- maps::map("world", plot = FALSE, fill = TRUE) %>%
  sf::st_as_sf() %>%
  # sf::st_union() %>%
  sf::st_transform(crs = crs_out) %>%
  dplyr::filter(ID %in% c("USA", "Russia", "Canada", "Mexico")) %>%
  dplyr::mutate(ID = ifelse(ID == "USA", "Alaska", ID))

place_labels <- data.frame(
  type = c("mainland", "mainland", "mainland", "mainland", "survey",
           "peninsula", "survey", "survey", "survey", "survey", "survey", "survey"),
  lab = c("Alaska", "Russia", "Canada", "USA", "West Coast",
          "Alaska Peninsula", "Aleutian Islands", "Gulf of Alaska",
          "Bering\nSea\nSlope", "Eastern\nBering Sea", "Northern\nBering Sea", "British Columbia"),
  angle = c(0, 0, 0, 0, -45, 45, 0, 30, 0, 0, 0, -30),
  lat = c(63, 62.798276, 58, 42, 40, 56.352495, 53.25, 54.720787,
          57, 57.456912, 62.25, 51),
  lon = c(-154, 173.205231, -122, -120, -125.2,
          -159.029430, -173, -154.794131, -176, -162, -170.5, -131)) %>%
  dplyr::filter(type != "peninsula") %>%
  sf::st_as_sf(coords = c("lon", "lat"),
               crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0") %>%
  sf::st_transform(crs = crs_out)

#Adjusting coordinates to zoom in: #Obtained from https://www.r-bloggers.com/2019/04/zooming-in-on-maps-with-sf-and-ggplot2/
disp_win_wgs84 <- st_sfc(st_point(c(-170, 30)), st_point(c(-90, 50)),
                         crs = 4326)
disp_win_trans <- st_transform(disp_win_wgs84, crs = crs_out)
disp_win_coord <- st_coordinates(disp_win_trans)

#Adjusting coordinates of survey points
locs_trans <- st_as_sf(locs, coords = c("lon", "lat"), crs = 4326)


map <- ggplot2::ggplot() +
  ggplot2::geom_sf(data = world_coordinates,
                   fill = "grey10",
                   color = "grey20") +
  geom_sf(data = locs_trans, mapping = aes(color = survey_id), size = 1) +
  ggplot2::geom_sf_text(
    data = place_labels %>% dplyr::filter(type == "mainland"),
    mapping = aes(label = lab, angle = angle),
    color = "grey60",
    size = 3,
    show.legend = FALSE) + 
  ggplot2::scale_x_continuous(name = "Longitude 째W",
                              breaks = c(170, seq(-180, -120, 10))) +
  ggplot2::scale_y_continuous(name = "Latitude 째N",
                              breaks = seq(30, 70, 10)) +
  ggplot2::coord_sf(xlim = sf::st_bbox(disp_win_trans)[c(1,3)],
                    ylim = sf::st_bbox(disp_win_trans)[c(2,4)]) +
  ggplot2::geom_sf_text(
    data = place_labels %>% dplyr::filter(type == "mainland"),
    mapping = aes(label = lab, angle = angle),
    color = "grey60",
    size = 3,
    show.legend = FALSE) +
  ggplot2::geom_sf_text(
    data = place_labels %>% dplyr::filter(type == "survey"),
    mapping = aes(label = lab, angle = angle),
    color = "black",
    fontface = "bold",
    size = 1.5,
    show.legend = FALSE) +
  ggplot2::geom_sf_text(
    data = place_labels %>% dplyr::filter(!(type %in% c("mainland", "survey"))),
    mapping = aes(label = lab, angle = angle),
    color = "grey10",
    fontface = "italic",
    size = 2,
    show.legend = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    plot.margin=unit(c(0,0,0,0), "cm"),
    strip.background = element_rect(fill = "transparent", colour = "white"),
    strip.text = element_text(face = "bold"), # , family = font0
    panel.border = element_rect(colour = "grey20", linewidth = .25, fill = NA),
    panel.background = element_rect(fill = "white"),
    panel.grid = element_line(colour="grey80", linewidth=0.5),
    plot.title = element_text(face = "bold"), # , size = 12, family = font0
    axis.text = element_text(face = "bold"), # , size = 12 , family = font0
    legend.position = c(0.32,0.26),
    legend.text = element_text(size = 6, margin = margin(r = 4, unit = "pt")),
    legend.key.spacing.x = unit(2, "pt"),
    legend.background = element_rect(fill = "white", color = NA)
  ) +
  guides(color = guide_legend(ncol = 3)) 

map
ggsave(here("figures", "Map of surveys_fancy.png"), width = 6, height = 6, units = "in")




```

```{r, include = FALSE}

##-------------------------------------------##
#Plotting by survey - not shown
##-------------------------------------------##

#Plotting all the surveys by species
ggplot(name_surv, aes(x = common_name, y = maxAge, colour = survey_id)) +
  geom_point() +
  labs(x = "Common Name",
       y = "Maximum Age") +
  theme(axis.text.x = element_text(
    angle = 90,
    hjust = 1,
    vjust = 0
    ))

#Plotting all the surveys by species with size dependent on countAge
ggplot(name_surv, 
       aes(x = common_name, y = maxAge, colour = survey_id, size = countAge)) +
  geom_point()
```

The maximum age from each survey for each species was obtained. Initial figures of maximum ages by survey were difficult to interpret given many surveys occurred within a similar region (e.g. Alaska waters are sampled by at least five separate surveys). However, the range of maximum values from each survey provides an initial determination of the variability across sampled maximum ages for a species. 

```{r, echo = FALSE}

##-------------------------------------------##
#Plotting by survey - shown
##-------------------------------------------##

#Output range across surveys

p_survey <- ggplot(name_surv_range, aes(x = common_name)) +
  geom_linerange(aes(ymin = rangeMin, ymax = rangeMax)) +
  geom_point(aes(y = rangeMin)) +
  geom_point(aes(y = rangeMax))+
  labs(x = "Common Name",
       y = "Maximum Age") +
  theme(axis.text.x = element_text(
    angle = 90,
    hjust = 1,
    vjust = 0
    ))
p_survey
ggsave(here("figures", "Range over surveys.png"), width = 8.5, height = 4, units = "in")
```

```{r, include = FALSE}

#NOT SHOWN

#Output range across surveys, with individual surveys added along with the relative sample size

p_survey + geom_point(data = name_surv, 
               aes(x = common_name, y = maxAge, colour = survey_id, size = countAge))
ggsave(here("figures", "Range over surveys_with survey_relative size.png"), width = 8.5, height = 4, units = "in")
```

When surveys within an area (either a U.S. state or Canada) are aggregated, the minimum of the range is compressed, reflecting a smaller range across areas.

```{r, echo = FALSE}

##-------------------------------------------##
#Plotting by area - shown
##-------------------------------------------##

p_area <- ggplot(name_area_range, aes(x = common_name)) +
  geom_linerange(aes(ymin = rangeMin, ymax = rangeMax)) +
  geom_point(aes(y = rangeMin)) +
  geom_point(aes(y = rangeMax))+
  labs(x = "Common Name",
       y = "Maximum Age") +
  theme(axis.text.x = element_text(
    angle = 90,
    hjust = 1,
    vjust = 0
    ))
p_area
ggsave(here("figures", "Range over areas.png"), width = 8.5, height = 4, units = "in")

```

The maximum ages of each individual area were then added to overall range. These areas are colored and ordered from north to south, to provide some initial ability to determine longitudinal patterns in maximum age estimates. A second figure provides the relative sample size of the surveys within each area.

```{r, echo = FALSE}

#Output range across surveys, with individual areas dded along with the relative sample size
p_area + geom_point(data = name_area, 
           aes(x = common_name, y = maxAge, colour = area)) +
  labs(x = "Common Name",
       y = "Maximum Age") +
  scale_colour_manual(values = c("CA" = "#CA0020",
                                 "OR" = "#F4A582",
                                 "WA" = "#e9c46a",
                                 "Canada" = "#92C5DE",
                                 "AK" = "#0571B0"),
                      breaks = c("AK", "Canada", "WA", "OR", "CA")) +
  theme(axis.text.x = element_text(
    angle = 90,
    hjust = 1,
    vjust = 0
    ))
ggsave(here("figures", "Range over areas_with survey.png"), width = 8.5, height = 4, units = "in")

p_area + geom_point(data = name_area, 
           aes(x = common_name, y = maxAge, 
               colour = area, size = countAge)) +
  labs(x = "Common Name",
       y = "Maximum Age") +
  scale_colour_manual(values = c("CA" = "#CA0020",
                                 "OR" = "#F4A582",
                                 "WA" = "#e9c46a",
                                 "Canada" = "#92C5DE",
                                 "AK" = "#0571B0"),
                      breaks = c("AK", "Canada", "WA", "OR", "CA")) +
  theme(axis.text.x = element_text(
    angle = 90,
    hjust = 1,
    vjust = 0
    ))
ggsave(here("figures", "Range over areas_with survey_relative.png"), width = 8.5, height = 4, units = "in")

```

If we look at only species that are caught in more than one area. We have something a little easier to look at, and provides a working starting point for the range of longevity estimates across areas. 


```{r, echo = FALSE}

##-------------------------------------------##
#Subsetting to species in multiple areas - shown
##-------------------------------------------##

#Species in more than one area
dup_species <- unique(name_area[duplicated(name_area$common_name), "common_name"])
p_area_subset <- ggplot(
  name_area_range %>% dplyr::filter(common_name %in% dup_species$common_name), 
  aes(x = common_name)) +
  geom_linerange(aes(ymin = rangeMin, ymax = rangeMax)) +
  geom_point(aes(y = rangeMin)) +
  geom_point(aes(y = rangeMax))+
  labs(x = "Common Name",
       y = "Maximum Age") +
  theme(axis.text.x = element_text(
    angle = 90,
    hjust = 1,
    vjust = 0
    ))
p_area_subset
ggsave(here("figures", "Range over areas_subset.png"), width = 8.5, height = 4, units = "in")

p_area_subset + geom_point(data = name_area %>% 
                             dplyr::filter(common_name %in% dup_species$common_name), 
           aes(x = common_name, y = maxAge, colour = area, size = countAge)) +
  labs(x = "Common Name",
       y = "Maximum Age") +
  scale_colour_manual(values = c("CA" = "#CA0020",
                                 "OR" = "#F4A582",
                                 "WA" = "#e9c46a",
                                 "Canada" = "#92C5DE",
                                 "AK" = "#0571B0"),
                      breaks = c("AK", "Canada", "WA", "OR", "CA")) +
  theme(axis.text.x = element_text(
    angle = 90,
    hjust = 1,
    vjust = 0
    ))
ggsave(here("figures", "Range over areas_subset_with survey_relative.png"), width = 8.5, height = 4, units = "in")

```


Looking at the range of maximum ages between areas, subsetted to species occuring in multiple areas, reveals some patterns. First the range varies by species. A total of `r sum(name_area_range$diff > 40)` species have a range greater than 40, and `r sum(name_area_range$diff > 25)` species have a range greater than 25. The majority of species have a small range, but many of these are species that do not occur over multiple areas, and therefore have a range of zero. Of the `r temp = name_area_range %>% dplyr::filter(common_name %in% dup_species$common_name)` `r nrow(temp)` species that occur in multiple areas, `r sum(temp$diff < 10)` have a range of less than 10. Second, a few species have latitudinal patterns where older fish are sampled in more northerly regions. These species include pacific oceanp perch, quillback rockfish, and yelloweye rockfish. Other species have latitudinal patterns that are opposite, and include sablefish and shortspine thornyhead. 

Looking at the individual data for species with the greatest range indicates that a lack of samples in some areas may be contributing to the large range in longevity estimates. 
